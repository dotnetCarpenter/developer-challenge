<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Game Overview</title>  
  <link href="css/ui-lightness/jquery-ui-1.10.3.custom.css" rel="stylesheet">
  <style>
    body { font-family: sans-serif; }
    .graph {
      width: 600px;
      height: 358px;
    }
    abbr {
      text-decoration: underline dashed;
      cursor: help;
    }
    svg path {
      stroke: #000;/*
      shape-rendering: crispEdges;*/
    }
  </style>
</head>
<body>
  <h1>Game Overview</h1>
  <fieldset>
    <legend>Controls</legend>
    <form>
      <label><input type="checkbox"/><abbr title="Multiple events happen at the exact same time. With this option checked, the events will be moved 1 minute, in order, until no events overlap each other. While the time representation will be skewed, the events will still match the overall game time proportionally.">Fake time distribution</abbr></label>
    </form>
  </fieldset>
  <div id="score">0</div>
  <div id="match" class="graph"></div>
  <script src="bower_components/lodash/dist/lodash.underscore.min.js"></script>
  <script src="bower_components/jquery/jquery.min.js"></script>
  <script src="bower_components/d3/d3.min.js"></script>
  <script>
    (function(doc, d3, _, $) {
      "use strict";

      d3.json("/developer-challenge/data/d3.mockup.json", function(error, data) {
        if (error) return console.warn(error);

        /*data = d3.nest() // divide data into 2 arrays by FirstHalf, SecondHalf
          .key(function(d) { return d.period })
          .entries(data);
        console.dir(data);*/
        
        data = _.filter(data, function(d) {
                  return !d.is_error; // remove error actions
                });
        var ftCheckbox = doc.querySelector("input[type='checkbox']");
        ftCheckbox.addEventListener("click", function(event) {
          if (!event.target.checked) {// stupid hack
            location.reload(true)
            return;
          }
          d3.select("svg").remove();
          d3.select("#score").html("0");
          run(event.target.checked, data.slice(0));
        });
        run(false, data.slice(0));

        


// animate pie
/*        canvas
  .append("g")
  .attr("transform", "translate(" + fl(width/2) + ", " + fl(height/2 + 25) + ")")
  .selectAll(".arc")
  .data( pie(d3.range(T)) )
  .enter()
  .append("path")
  .attr("fill", color(0))
  .transition()
  .duration(T*1000)
  .attrTween("d", arcTween);*/
      });
      function run(faketime, dataset) {
        var st = same("minutes");
    //    console.log(faketime, _.each(dataset, function(d) { console.log(d.minutes) }));
        if( faketime ) {
          while( hasSame(dataset, st) ) {
            dataset = _.map(dataset, fakeTime)
                    .sort(comparator);
          }
        }
        var T       = _.max(dataset, function(d) {
                        return d.minutes;
                      }).minutes +1, // +1 or T and 0 minutes are in the same position
            width   = 600,
            height  = 358,
            canvas  = d3.select("#match")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height),
            score   = d3.select("#score"),
            color   = d3.scale.category20(),
            radius  = Math.min(width, height-50) / 2,
            radian2 = Math.PI * 2,
            arc     = d3.svg.arc()
                        .innerRadius(radius - 40)
                        .outerRadius(radius),
                        //.startAngle(0),/*
                        //.endAngle(radian2),*/
            path    = canvas.append("g")
                        .attr("transform", "translate(" + fl(width/2) + ", " + fl(height/2 + 25) + ")")
                        .selectAll("path")
                        .data(dataset)
                      .enter()
                        .append("path")
                        .attr("fill", function(d, i) { return color(i); })
                        .attr("d", function(d) {
                          d.startAngle = radiant(d);
                          d.endAngle = radiant({ minutes: d.minutes + 1 });
                          return arc(d);
                        })  // the title attribute and class name is a hack to get jQuery tooltip to work
                            // not proper SVG
                        .attr("title", function(d) {
                          return d.action_name + " - " + new Date(d.timestamp).toLocaleTimeString();
                        })
                        .attr("class", "ev"),
            title   = path
                        .append("title")
                        .text(function(d) {
                          return d.action_name + " - " + new Date(d.timestamp).toLocaleTimeString();
                        });
            /*,pie     = d3.layout.pie()/*
                        .value(function(d) {
                          return d;
                        });*/// used to control animation;

        path
          .transition()
          .duration(T*10)
          .attrTween("d", arcTween);

        jQuery(function($) {
          $("*[title], svg .ev").tooltip();
        });

        function radiant(d) {
          return (d.minutes/T) * radian2;
        }
        function comparator(a,b) {
          //console.log(a.timestamp < b.timestamp);
          var val1 = a.minutes,
              val2 = b.minutes;
          return val1 == val2 ? 0 : val1 < val2 ? -1 : 1;
        }
        function arcTween(d, index) {
          var i = d3.interpolate({startAngle: 0, endAngle: 0}, d);
          setTimeout(function() {
            score.text( parseInt(score.text()) + d.total_points );
          }, index * 10)          
          return function(t) { return arc(i(t)); };
        }
        function fl(val) {
          return Math.floor(val);
        }
        function hasSame(list, comparor) {
          return _.some(list, function(d, i, all) {
            return i === 0 ? false : comparor(d, all[i-1]);
          });
        }
        // add 1 minute to actions happening at the exact same time [not pure]
        function fakeTime(d, i, all) {
          if(i !== 0) {
            while( st(d, all[i-1]))
              add1min(d);
          }
          return d;
        }
        function same(prop) {
          return function(v1, v2) {
            return v1[prop] === v2[prop];
          }
        }
        function add1min(d) {
          return d.minutes += 1, d;
        }
      }
    }(document, d3, _, jQuery))
  </script>
  <script src="js/jquery.tooltip.min.js"></script>
</body>
</html>