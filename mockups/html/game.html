<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Game Overview</title>
  <style>
    body { font-family: sans-serif; }
    .graph {
      width: 600px;
      height: 338px;
    }
  </style>
</head>
<body>
  <h1>Game Overview</h1>
  <div id="match" class="graph"></div>
  <script src="bower_components/lodash/dist/lodash.underscore.min.js"></script>
  <script src="bower_components/d3/d3.js"></script>
  <script>
    (function(doc, d3) {
      "use strict";
      d3.json("/data/d3.mockup.json", function(error, data) {
        if (error) return console.warn(error);

        /*data = d3.nest() // divide data into 2 arrays by FirstHalf, SecondHalf
          .key(function(d) { return d.period })
          .entries(data);
        console.dir(data);*/
        // remove error actions
        var st = same("minutes");
        data = _.filter(data, function(d) {
                  return !d.is_error;
                })// add 1 minute to actions happening at the exact same time
                .map(function(d, i, all) {
                  if(i !== 0 && i !== all.length-1) {
                    while( st(d, all[i+1]) || st(d, all[i-1]))
                      add1min(d);
                  }
                  return d;
                });

        var T       = _.max(data, function(d) {
                        return d.minutes;
                      }).minutes,
            width   = 600,
            height  = 338,
            canvas  = d3.select("#match")
                        .append("svg")
                        .attr("width", width)
                        .attr("height", height)
                      .append("g")
                        .attr("transform", "translate(" + width/2 + ", " + height/2 + ")"),
            color   = d3.scale.category20(),                        
            radius  = Math.min(width, height) / 2,
            radian2 = Math.PI * 2,
            pie     = d3.layout.pie()
                        .value(function(d) {
                          return d.minutes;//(d.minutes/T) * radian2;
                        })
                        .sort(comparator),
            arc     = d3.svg.arc()
                        .innerRadius(radius - 40)
                        .outerRadius(radius),
                        //.startAngle(0),/*
                        //.endAngle(r360),*/
            path    = canvas.selectAll("path")
                        .data(pie(data))
                      .enter()
                        .append("path")
                        .attr("fill", function(d, i) { return color(i); })
                        .attr("d", function(d) {
                          d.startAngle = radiant(d.data);
                          d.endAngle = radiant({ minutes: d.data.minutes + 1 });
                          return arc(d);
                        })
                        .append("title")
                        .text(function(d) {
                          d = d.data;
                          return d.action_name + " - " + new Date(d.timestamp).toLocaleTimeString();
                        });
          function same(prop) {
            return function(v1, v2) {
              return v1[prop] === v2[prop];
            }
          }
          function add1min(d) {
            return d.minutes += 1, d;
          }
          function radiant(d) {
            return (d.minutes/T) * radian2;
          }
            // group.append("path")
            //   .data( pie(data) )
            //   .value(function(d) {
            //     return d.minutes;//convert later
            //   })
            // .enter()
            //   .append("path")
            //   .attr("fill", function(d, i) { return color(i); })
            //   .attr("d", arc);
        function comparator(a,b) {
          //console.log(a.timestamp < b.timestamp);
          var val1 = a.timestamp,
              val2 = b.timestamp;
          return val1 == val2 ? 0 : val1 < val2 ? -1 : 1;
        };
      });
    }(document, d3))
  </script>
</body>
</html>